---
import { getCollection, render } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';

export async function getStaticPaths() {
  const allProjects = await getCollection('projects');
  const esProjects = allProjects
    .filter((p) => p.data.lang === 'es')
    .sort((a, b) => a.data.order - b.data.order);

  return esProjects.map((project, index) => {
    const slug = project.id.replace(/^es\//, '');
    const prev = index > 0 ? esProjects[index - 1] : null;
    const next = index < esProjects.length - 1 ? esProjects[index + 1] : null;
    return {
      params: { slug },
      props: { project, prev, next },
    };
  });
}

const { project, prev, next } = Astro.props;
const { Content } = await render(project);

const categoryLabels: Record<string, string> = {
  web: 'Web',
  system: 'Sistema',
  integration: 'Integración',
  mobile: 'Móvil',
  game: 'Videojuego',
  devops: 'DevOps',
};

const categoryIcons: Record<string, string> = {
  web: 'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z',
  mobile: 'M17 1.01L7 1c-1.1 0-2 .9-2 2v18c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V3c0-1.1-.9-1.99-2-1.99zM17 19H7V5h10v14z',
  system: 'M20 18c1.1 0 1.99-.9 1.99-2L22 6c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2H0v2h24v-2h-4zM4 6h16v10H4V6z',
  integration: 'M13.127 14.56l1.43-1.43 6.44 6.443L19.57 21l-6.44-6.44zm-2.254-2.253l-3.291 3.291a1 1 0 01-1.414 0l-3.536-3.535a1 1 0 010-1.415l3.291-3.29-1.06-1.06 1.413-1.415 9.193 9.193-1.414 1.414-1.06-1.061z',
  game: 'M21 6H3c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-10 7H8v3H6v-3H3v-2h3V8h2v3h3v2zm4.5 2c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm4-3c-.83 0-1.5-.67-1.5-1.5S18.67 9 19.5 9s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z',
  devops: 'M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM10 17l-3.5-3.5 1.41-1.41L10 14.17l4.59-4.58L16 11l-6 6z',
};

// Tech color map (same as ProjectFilter)
const TECH_COLORS: Record<string, string> = {
  'React': '#61DAFB', 'React Native': '#61DAFB', 'TypeScript': '#3178C6',
  'Node.js': '#539E43', 'Go': '#00ADD8', 'Docker': '#2496ED',
  'PostgreSQL': '#336791', 'AWS': '#FF9900', 'Terraform': '#7B42BC',
  'Kubernetes': '#326CE5', 'Godot': '#478CBF', 'Electron': '#47848F',
  'Astro': '#FF5D01', 'Tailwind': '#06B6D4', 'MySQL': '#4479A1',
  'Stripe': '#635BFF', 'PHP': '#777BB4', 'SQLite': '#003B57',
  'REST API': '#FF6C37', 'Next.js': '#000000', 'D3.js': '#F9A03C',
  'WebSockets': '#FF6600', 'RabbitMQ': '#FF6600', 'gRPC': '#244C5A',
  'GitHub Actions': '#2088FF', 'Linux': '#FCC624', 'Framer Motion': '#0055FF',
  'Vercel': '#000000', 'WhatsApp API': '#25D366', 'GDScript': '#478CBF',
  'Aseprite': '#7D929E', 'Pixel Art': '#E91E63',
};
---

<BaseLayout
  title={project.data.title}
  description={project.data.description}
  ogImage={project.data.heroImage}
>
  <article class="project-detail">
    <div class="detail-container">
      <!-- Back link -->
      <a href="/es/proyectos/" class="back-link" data-reveal>
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
        Todos los proyectos
      </a>

      <!-- Hero image -->
      <div class="hero-image" data-reveal>
        <img
          src={project.data.heroImage}
          alt={project.data.title}
        />
        <div class="hero-gradient"></div>
        <div class="hero-badge">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d={categoryIcons[project.data.category] || categoryIcons.web}/></svg>
          {categoryLabels[project.data.category] || project.data.category}
        </div>
      </div>

      <!-- Header -->
      <div class="header" data-reveal>
        <div class="header-badges">
          <span class="category-pill">
            {categoryLabels[project.data.category] || project.data.category}
          </span>
          {project.data.featured && (
            <span class="featured-pill">
              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
              Destacado
            </span>
          )}
        </div>
        <h1 class="title">{project.data.title}</h1>
        <p class="description">{project.data.description}</p>
      </div>

      <!-- Tech Stack -->
      <div class="tech-stack" data-reveal>
        <h2 class="section-label">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
          Stack tecnológico
        </h2>
        <div class="tags-list">
          {project.data.tags.map((tag: string) => (
            <span class="tech-tag" style={`--tag-color: ${TECH_COLORS[tag] || 'var(--color-accent-primary)'}`}>
              <span class="tech-dot" style={`background: ${TECH_COLORS[tag] || 'var(--color-accent-primary)'}`}></span>
              {tag}
            </span>
          ))}
        </div>
      </div>

      <!-- Screenshots -->
      {project.data.screenshots && project.data.screenshots.length > 0 && (
        <div class="screenshots" data-reveal>
          <h2 class="section-label">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
            Capturas de pantalla
          </h2>
          <div class="screenshots-grid">
            {project.data.screenshots.map((src: string, i: number) => (
              <div class="screenshot-card">
                <img src={src} alt={`Captura ${i + 1}`} loading="lazy" />
              </div>
            ))}
          </div>
        </div>
      )}

      <!-- Content -->
      <div class="prose-custom" data-reveal>
        <Content />
      </div>

      <!-- Navigation -->
      <div class="project-nav" data-reveal>
        <div class="nav-inner">
          {prev ? (
            <a href={`/es/proyectos/${prev.id.replace(/^es\//, '')}/`} class="nav-link nav-prev">
              <span class="nav-direction">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
                Anterior
              </span>
              <span class="nav-title">{prev.data.title}</span>
            </a>
          ) : <div />}
          {next ? (
            <a href={`/es/proyectos/${next.id.replace(/^es\//, '')}/`} class="nav-link nav-next">
              <span class="nav-direction">
                Siguiente
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
              </span>
              <span class="nav-title">{next.data.title}</span>
            </a>
          ) : <div />}
        </div>

        <!-- Back to all -->
        <a href="/es/proyectos/" class="back-btn">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M4 8h4V4H4v4zm6 12h4v-4h-4v4zm-6 0h4v-4H4v4zm0-6h4v-4H4v4zm6 0h4v-4h-4v4zm6-10v4h4V4h-4zm-6 4h4V4h-4v4zm6 6h4v-4h-4v4zm0 6h4v-4h-4v4z"/></svg>
          Ver todos los proyectos
        </a>
      </div>
    </div>
  </article>
</BaseLayout>

<script>
  // Scroll-reveal animation
  const reveals = document.querySelectorAll('[data-reveal]');
  const observer = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          (entry.target as HTMLElement).classList.add('revealed');
          observer.unobserve(entry.target);
        }
      });
    },
    { threshold: 0.1, rootMargin: '0px 0px -40px 0px' }
  );
  reveals.forEach((el) => observer.observe(el));
</script>

<style>
  /* ─── Layout ─── */
  .project-detail {
    padding: 4rem 1rem;
  }

  @media (min-width: 640px) {
    .project-detail {
      padding: 5rem 1.5rem;
    }
  }

  @media (min-width: 1024px) {
    .project-detail {
      padding: 5rem 2rem;
    }
  }

  .detail-container {
    max-width: 52rem;
    margin: 0 auto;
  }

  /* ─── Reveal animation ─── */
  [data-reveal] {
    opacity: 0;
    transform: translateY(24px);
    transition: opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1), transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  }

  [data-reveal].revealed {
    opacity: 1;
    transform: translateY(0);
  }

  /* Stagger delays */
  [data-reveal]:nth-child(2) { transition-delay: 0.05s; }
  [data-reveal]:nth-child(3) { transition-delay: 0.1s; }
  [data-reveal]:nth-child(4) { transition-delay: 0.15s; }
  [data-reveal]:nth-child(5) { transition-delay: 0.2s; }
  [data-reveal]:nth-child(6) { transition-delay: 0.25s; }
  [data-reveal]:nth-child(7) { transition-delay: 0.3s; }

  /* ─── Back link ─── */
  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--color-text-secondary);
    text-decoration: none;
    margin-bottom: 1.5rem;
    padding: 0.375rem 0.75rem 0.375rem 0.5rem;
    border-radius: 9999px;
    border: 1px solid transparent;
    transition: all 0.25s ease;
  }

  .back-link:hover {
    color: var(--color-accent-primary);
    background: var(--color-accent-subtle);
    border-color: var(--color-accent-primary);
    transform: translateX(-2px);
  }

  /* ─── Hero image ─── */
  .hero-image {
    position: relative;
    overflow: hidden;
    border-radius: 1rem;
    border: 1px solid var(--color-border);
    aspect-ratio: 16 / 9;
  }

  .hero-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s ease;
  }

  .hero-image:hover img {
    transform: scale(1.02);
  }

  .hero-gradient {
    position: absolute;
    inset: 0;
    background: linear-gradient(to top, rgba(0,0,0,0.4) 0%, transparent 40%);
    pointer-events: none;
  }

  .hero-badge {
    position: absolute;
    bottom: 1rem;
    left: 1rem;
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 0.375rem 0.875rem;
    border-radius: 9999px;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(12px);
    color: #f1f5f9;
    border: 1px solid rgba(255, 255, 255, 0.15);
  }

  /* ─── Header ─── */
  .header {
    margin-top: 2rem;
  }

  .header-badges {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }

  .category-pill {
    font-size: 0.6875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    padding: 0.3rem 0.875rem;
    border-radius: 9999px;
    background: var(--color-accent-subtle);
    color: var(--color-accent-primary);
    border: 1px solid color-mix(in srgb, var(--color-accent-primary) 20%, transparent);
  }

  .featured-pill {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    font-size: 0.6875rem;
    font-weight: 600;
    padding: 0.3rem 0.875rem;
    border-radius: 9999px;
    background: #fef3c7;
    color: #92400e;
    border: 1px solid #fde68a;
  }

  :global([data-theme="dark"]) .featured-pill {
    background: rgba(251, 191, 36, 0.15);
    color: #fbbf24;
    border-color: rgba(251, 191, 36, 0.25);
  }

  .title {
    font-family: var(--font-display);
    font-weight: 800;
    font-size: 2rem;
    line-height: 1.2;
    color: var(--color-text-primary);
    letter-spacing: -0.02em;
  }

  @media (min-width: 640px) {
    .title {
      font-size: 2.5rem;
    }
  }

  .description {
    margin-top: 0.75rem;
    font-size: 1.125rem;
    line-height: 1.7;
    color: var(--color-text-secondary);
  }

  /* ─── Tech Stack ─── */
  .tech-stack {
    margin-top: 2rem;
    padding: 1.25rem 1.5rem;
    border-radius: 0.875rem;
    background: var(--color-bg-elevated);
    border: 1px solid var(--color-border);
  }

  .section-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-family: var(--font-display);
    font-weight: 600;
    font-size: 0.8125rem;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--color-text-muted);
    margin-bottom: 0.875rem;
  }

  .tags-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .tech-tag {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.8125rem;
    padding: 0.375rem 0.75rem;
    border-radius: 9999px;
    background: var(--color-bg-secondary);
    color: var(--color-text-secondary);
    font-weight: 500;
    font-family: var(--font-mono);
    letter-spacing: -0.01em;
    border: 1px solid var(--color-border);
    transition: all 0.2s ease;
  }

  .tech-tag:hover {
    border-color: var(--tag-color);
    background: color-mix(in srgb, var(--tag-color) 8%, transparent);
    color: var(--color-text-primary);
    transform: translateY(-1px);
  }

  .tech-dot {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    flex-shrink: 0;
    box-shadow: 0 0 4px color-mix(in srgb, var(--tag-color) 40%, transparent);
  }

  /* ─── Screenshots ─── */
  .screenshots {
    margin-top: 2.5rem;
  }

  .screenshots-grid {
    display: grid;
    gap: 1rem;
    grid-template-columns: 1fr;
  }

  @media (min-width: 640px) {
    .screenshots-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  .screenshot-card {
    overflow: hidden;
    border-radius: 0.75rem;
    border: 1px solid var(--color-border);
    transition: all 0.3s ease;
  }

  .screenshot-card:hover {
    border-color: var(--color-accent-light);
    box-shadow: 0 8px 24px rgba(37, 99, 235, 0.08);
    transform: translateY(-2px);
  }

  .screenshot-card img {
    width: 100%;
    display: block;
    object-fit: cover;
    transition: transform 0.4s ease;
  }

  .screenshot-card:hover img {
    transform: scale(1.03);
  }

  /* ─── Prose Content ─── */
  .prose-custom {
    margin-top: 2.5rem;
    padding-top: 2rem;
    border-top: 1px solid var(--color-border);
  }

  .prose-custom :global(h2) {
    font-family: var(--font-display);
    font-weight: 700;
    font-size: 1.5rem;
    margin-top: 2.5rem;
    margin-bottom: 0.75rem;
    color: var(--color-text-primary);
    letter-spacing: -0.01em;
    position: relative;
    padding-left: 1rem;
  }

  .prose-custom :global(h2)::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0.2em;
    bottom: 0.2em;
    width: 3px;
    border-radius: 3px;
    background: var(--color-accent-primary);
  }

  .prose-custom :global(h3) {
    font-family: var(--font-display);
    font-weight: 600;
    font-size: 1.25rem;
    margin-top: 2rem;
    margin-bottom: 0.5rem;
    color: var(--color-text-primary);
  }

  .prose-custom :global(p) {
    line-height: 1.8;
    margin-bottom: 1.25rem;
    color: var(--color-text-secondary);
  }

  .prose-custom :global(ul) {
    list-style: none;
    padding-left: 0;
    margin-bottom: 1.25rem;
  }

  .prose-custom :global(li) {
    line-height: 1.75;
    margin-bottom: 0.5rem;
    color: var(--color-text-secondary);
    padding-left: 1.5rem;
    position: relative;
  }

  .prose-custom :global(li)::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0.7em;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--color-accent-primary);
  }

  .prose-custom :global(strong) {
    color: var(--color-text-primary);
    font-weight: 600;
  }

  .prose-custom :global(code) {
    font-family: var(--font-mono);
    font-size: 0.85em;
    padding: 0.15rem 0.4rem;
    border-radius: 0.25rem;
    background: var(--color-bg-secondary);
    color: var(--color-accent-primary);
    border: 1px solid var(--color-border);
  }

  .prose-custom :global(a) {
    color: var(--color-accent-primary);
    text-decoration: underline;
    text-decoration-color: color-mix(in srgb, var(--color-accent-primary) 30%, transparent);
    text-underline-offset: 2px;
    transition: text-decoration-color 0.2s ease;
  }

  .prose-custom :global(a:hover) {
    text-decoration-color: var(--color-accent-primary);
  }

  .prose-custom :global(blockquote) {
    border-left: 3px solid var(--color-accent-primary);
    padding-left: 1rem;
    margin: 1.5rem 0;
    font-style: italic;
    color: var(--color-text-muted);
  }

  /* ─── Navigation ─── */
  .project-nav {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid var(--color-border);
  }

  .nav-inner {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  @media (max-width: 640px) {
    .nav-inner {
      grid-template-columns: 1fr;
    }
  }

  .nav-link {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
    padding: 1rem 1.25rem;
    border-radius: 0.75rem;
    border: 1px solid var(--color-border);
    background: var(--color-bg-elevated);
    text-decoration: none;
    transition: all 0.25s ease;
  }

  .nav-link:hover {
    border-color: var(--color-accent-primary);
    background: var(--color-accent-subtle);
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(37, 99, 235, 0.08);
  }

  .nav-next {
    text-align: right;
    align-items: flex-end;
  }

  .nav-direction {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--color-accent-primary);
  }

  .nav-title {
    font-family: var(--font-display);
    font-weight: 600;
    font-size: 0.9375rem;
    color: var(--color-text-primary);
    line-height: 1.3;
  }

  .back-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    width: 100%;
    padding: 0.75rem 1.5rem;
    border-radius: 0.75rem;
    background: var(--color-accent-primary);
    color: #fff;
    font-size: 0.875rem;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.25s ease;
  }

  .back-btn:hover {
    opacity: 0.9;
    transform: translateY(-1px);
    box-shadow: 0 4px 16px rgba(37, 99, 235, 0.3);
  }
</style>
