---
import '../styles/global.css';
import '../styles/prose.css';
import { ViewTransitions } from 'astro:transitions';
import Header from '../components/layout/Header.astro';
import Footer from '../components/layout/Footer.astro';
import ToastContainer from '../components/ui/ToastContainer.svelte';
import TableOfContents from '../components/blog/TableOfContents.svelte';
import CopyButton from '../components/blog/CopyButton.svelte';
import { getLangFromUrl } from '../i18n/utils';

interface Props {
  title: string;
  description: string;
  pubDate: Date;
  updatedDate?: Date;
  heroImage?: string;
  tags: string[];
  category: string;
  headings: { depth: number; slug: string; text: string }[];
  prevPost?: { slug: string; title: string } | null;
  nextPost?: { slug: string; title: string } | null;
}

const {
  title,
  description,
  pubDate,
  updatedDate,
  heroImage,
  tags,
  category,
  headings,
  prevPost,
  nextPost,
} = Astro.props;

const lang = getLangFromUrl(Astro.url);
const canonicalUrl = new URL(Astro.url.pathname, Astro.site);
const ogImage = new URL(`/og${Astro.url.pathname.replace(/\/$/, '')}.png`, Astro.site).href;
const blogPath = `/${lang}/blog/`;
const backLabel = lang === 'es' ? 'Volver al blog' : 'Back to blog';
const tocLabel = lang === 'es' ? 'Tabla de contenidos' : 'Table of Contents';

const categoryLabels: Record<string, Record<string, string>> = {
  tutorial: { es: 'Tutorial', en: 'Tutorial' },
  'case-study': { es: 'Caso de estudio', en: 'Case Study' },
  opinion: { es: 'Opinión', en: 'Opinion' },
  project: { es: 'Proyecto', en: 'Project' },
};

function formatDate(date: Date): string {
  return date.toLocaleDateString(lang === 'es' ? 'es-MX' : 'en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
}

const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: title,
  description,
  datePublished: pubDate.toISOString(),
  dateModified: (updatedDate ?? pubDate).toISOString(),
  author: {
    '@type': 'Person',
    name: 'Joel Ernesto López Verdugo',
    jobTitle: 'Ingeniero en Computación',
    url: 'https://joledev.com',
  },
  keywords: tags.join(', '),
  image: ogImage,
  url: canonicalUrl.href,
};
---

<!doctype html>
<html lang={lang}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="sitemap" href="/sitemap-index.xml" />
    <link rel="alternate" type="application/rss+xml" title="JoleDev Blog" href="/feed.xml" />

    <title>{title} | JoleDev</title>
    <meta name="description" content={description} />
    <link rel="canonical" href={canonicalUrl.href} />

    <meta property="og:type" content="article" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:url" content={canonicalUrl.href} />
    <meta property="article:published_time" content={pubDate.toISOString()} />
    {tags.map((tag) => <meta property="article:tag" content={tag} />)}

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImage} />

    <link
      href="https://api.fontshare.com/v2/css?f[]=satoshi@700,900&display=swap"
      rel="stylesheet"
    />

    <ViewTransitions />

    <script is:inline>
      function applyTheme() {
        const saved = localStorage.getItem('theme');
        if (saved) {
          document.documentElement.setAttribute('data-theme', saved);
        } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
          document.documentElement.setAttribute('data-theme', 'dark');
        }
      }
      applyTheme();
      document.addEventListener('astro:after-swap', applyTheme);
    </script>

    <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
  </head>
  <body class="min-h-screen bg-bg-primary text-text-primary">
    <Header transition:name="header" transition:animate="none" />
    <main class="px-4 py-12 sm:px-6 sm:py-16 lg:px-8" transition:animate="fade">
      <div class="mx-auto max-w-6xl">
        <!-- Back link -->
        <a
          href={blogPath}
          class="inline-flex items-center gap-1.5 text-sm text-text-muted transition-colors hover:text-accent-primary"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
          {backLabel}
        </a>

        <!-- Article header -->
        <header class="mx-auto mt-8 max-w-3xl">
          <div class="flex items-center gap-3 text-sm">
            <span class="rounded-full bg-secondary-subtle px-3 py-0.5 text-xs font-semibold uppercase tracking-wide text-secondary-primary">
              {categoryLabels[category]?.[lang] ?? category}
            </span>
            <span class="text-text-muted">&middot;</span>
            <time class="text-text-muted" datetime={pubDate.toISOString()}>
              {formatDate(pubDate)}
            </time>
          </div>
          <h1 class="mt-4 font-display text-3xl font-bold leading-tight sm:text-4xl lg:text-5xl">
            {title}
          </h1>
          <p class="mt-4 text-lg text-text-secondary">{description}</p>
        </header>

        <!-- Content layout: article + TOC -->
        <div class="mx-auto mt-12 max-w-3xl lg:grid lg:max-w-6xl lg:grid-cols-[1fr_220px] lg:gap-12">
          <div>
            <!-- Mobile TOC -->
            <div class="lg:hidden">
              <TableOfContents client:load headings={headings} label={tocLabel} />
            </div>

            <!-- Article content -->
            <article class="prose">
              <slot />
            </article>

            <!-- Tags -->
            <div class="mt-10 flex flex-wrap gap-2 border-t border-border pt-6">
              {tags.map((tag) => (
                <span class="rounded-md bg-secondary-subtle px-3 py-1 text-sm font-medium text-secondary-primary">
                  {tag}
                </span>
              ))}
            </div>

            <!-- Prev / Next navigation -->
            {(prevPost || nextPost) && (
              <nav class="mt-8 grid gap-4 border-t border-border pt-8 sm:grid-cols-2">
                {prevPost ? (
                  <a href={`/${lang}/blog/${prevPost.slug}/`} class="group flex items-start gap-2 text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mt-0.5 shrink-0 text-text-muted transition-transform group-hover:-translate-x-1"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
                    <span class="text-text-secondary transition-colors group-hover:text-accent-primary">{prevPost.title}</span>
                  </a>
                ) : <div />}
                {nextPost && (
                  <a href={`/${lang}/blog/${nextPost.slug}/`} class="group flex items-start justify-end gap-2 text-right text-sm">
                    <span class="text-text-secondary transition-colors group-hover:text-accent-primary">{nextPost.title}</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mt-0.5 shrink-0 text-text-muted transition-transform group-hover:translate-x-1"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
                  </a>
                )}
              </nav>
            )}
          </div>

          <!-- Desktop TOC -->
          <aside class="hidden lg:block">
            <TableOfContents client:load headings={headings} label={tocLabel} />
          </aside>
        </div>
      </div>
    </main>
    <Footer transition:name="footer" transition:animate="none" />
    <ToastContainer client:idle />

    <!-- Wrap code blocks for copy button (re-runs on view transition navigation) -->
    <script>
      function initCodeBlocks() {
        document.querySelectorAll('.prose pre:not(.code-wrapped)').forEach((pre) => {
          pre.classList.add('code-wrapped');
          const wrapper = document.createElement('div');
          wrapper.className = 'code-block-wrapper';
          wrapper.style.position = 'relative';
          pre.parentNode?.insertBefore(wrapper, pre);
          wrapper.appendChild(pre);
        });
      }
      initCodeBlocks();
      document.addEventListener('astro:page-load', initCodeBlocks);
    </script>

    <!-- Mermaid diagram rendering (re-runs on view transition navigation) -->
    <script is:inline>
      function initMermaid() {
        var els = document.querySelectorAll('.mermaid:not([data-processed])');
        if (!els.length) return;
        var isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        var script = document.createElement('script');
        script.type = 'module';
        script.textContent =
          'import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs";' +
          'mermaid.initialize({ startOnLoad: false, theme: "' + (isDark ? 'dark' : 'default') + '", fontFamily: "var(--font-sans)" });' +
          'mermaid.run({ nodes: document.querySelectorAll(".mermaid:not([data-processed])") });';
        document.body.appendChild(script);
      }
      initMermaid();
      document.addEventListener('astro:page-load', initMermaid);
    </script>
  </body>
</html>
